<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Spirits Notifications</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg-0: #ffffff;
        --bg-1: #ffffff;
        --panel: #ffffff;
        --panel-muted: #f4f9ff;
        --text-main: #1a4e86;
        --text-muted: #4b6f95;
        --accent: #0000ff;
        --accent-2: #80ffff;
        --danger: #d43d3d;
        --ok: #0000ff;
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        color: var(--text-main);
        background: var(--bg-0);
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        overflow: hidden;
      }

      .app {
        height: 100%;
        display: grid;
        grid-template-rows: auto auto 1fr;
      }

      .top {
        padding: 16px 16px 10px;
        border-bottom: 1px solid #c4d9ef;
        background: linear-gradient(180deg, #ffffff 0%, #f5faff 100%);
      }

      .top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .title-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--ok);
        box-shadow: 0 0 0 6px #0000ff22;
      }

      .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 12px;
      }

      .pill {
        border: 1px solid #b5cae2;
        border-radius: 999px;
        padding: 4px 10px;
        background: #ffffff;
      }

      .status {
        margin: 12px 16px 0;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1.4;
        border: 1px solid #b7cee7;
        background: #f4f9ff;
        color: var(--text-main);
      }

      .status.ok {
        border-color: #80ffff;
        background: #eefeff;
      }

      .status.warn {
        border-color: #ffff80;
        background: #fffef0;
      }

      .status.error {
        border-color: #f0a8a8;
        background: #fff2f2;
      }

      .feed {
        min-height: 0;
        overflow: auto;
        padding: 14px 12px 16px;
        display: grid;
        grid-template-columns: 1fr;
        align-content: start;
        gap: 10px;
      }

      .empty {
        margin: 24px 6px 0;
        padding: 16px;
        border-radius: var(--radius);
        border: 1px dashed #80ffff;
        color: var(--text-muted);
        text-align: center;
        background: #f6ffff;
      }

      .card {
        border: 1px solid #3f88c7;
        border-radius: var(--radius);
        background: linear-gradient(180deg, #5ba9e6 0%, #458fcd 100%);
        padding: 12px;
        box-shadow: 0 8px 20px #2a618f47, inset 0 1px 0 #bfe0f861;
      }

      .card.new {
        border-color: #6dc3ff;
        background: linear-gradient(180deg, #6bbbf6 0%, #519fdd 100%);
        box-shadow: 0 0 0 1px #9be1ff72, 0 10px 24px #3177b954;
      }

      .card.read {
        border-color: #9ca9ba;
        background: linear-gradient(180deg, #758499 0%, #657486 100%);
        box-shadow: 0 6px 18px #4756673b, inset 0 1px 0 #d8e0e933;
      }

      .card.read .card-title,
      .card.read .content {
        color: #f2f7fc;
      }

      .card.read .time {
        color: #dbe4ee;
      }

      .card.read .badge {
        border-color: #c8d2de;
        background: #8b99ab;
        color: #f3f7fb;
      }

      .card-head {
        display: flex;
        align-items: start;
        justify-content: space-between;
        gap: 10px;
      }

      .card-title {
        margin: 0;
        font-size: 15px;
        line-height: 1.3;
      }

      .card:not(.read) .card-title,
      .card:not(.read) .content {
        color: #ffffff;
        text-shadow: 0 1px 1px #255c879c;
      }

      .card:not(.read) .time {
        color: #e8f5ff;
      }

      .card-meta {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .badge {
        border: 1px solid #6aa9db;
        background: #2d74b2;
        color: #f5fbff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
      }

      .time {
        color: #2a5f94;
        font-size: 11px;
      }

      .content {
        margin: 10px 0 0;
        white-space: pre-wrap;
        font-size: 13px;
        line-height: 1.45;
        color: #1d4f82;
      }

      .card-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
      }

      .link-btn {
        border: 1px solid #8eb7df;
        background: linear-gradient(180deg, #f7fbff, #ecf4ff);
        color: #1a4e86;
        padding: 6px 10px;
        border-radius: 9px;
        font-size: 12px;
        cursor: pointer;
      }

      .link-btn:hover {
        filter: brightness(1.06);
      }

      .link-btn:disabled {
        cursor: default;
        opacity: 0.72;
        filter: none;
      }

      .mark-read-btn {
        border-color: #7aa8d0;
        background: #f6fbff;
        color: #1a4e86;
        font-weight: 700;
      }

      .archive-toggle {
        border-color: #7aa8d0;
        font-weight: 700;
      }

      .archive-toggle.active {
        border-color: #2b7fc1;
        background: linear-gradient(180deg, #dff0ff, #c9e5ff);
        color: #15426f;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <div class="top-row">
          <div class="title">
            <span class="title-dot" id="titleDot"></span>
            <span>Spirits Notifications</span>
          </div>
          <div class="meta">
            <span class="pill" id="countPill">Posts: --</span>
            <button type="button" class="link-btn archive-toggle" id="archiveBtn" hidden>ARCHIVED MESSAGES</button>
          </div>
        </div>
      </div>

      <div id="status" class="status">Starting…</div>

      <main id="feed" class="feed" aria-live="polite"></main>
    </div>

    <script>
      (function () {
        let booted = false;
        const READ_IDS_KEY_NON_ARCHIVE = "bv_read_post_ids_non_archive_v2";
        const READ_IDS_KEY_ARCHIVE = "bv_read_post_ids_archive_v2";

        const state = {
          status: "loading",
          message: "Starting…",
          refreshMs: 0,
          lastSyncUtc: null,
          configPath: "",
          posts: [],
          newPostIds: [],
          archiveEnabled: false,
          archivedMessages: [],
          showArchived: false
        };
        const readPostIds = new Set();

        function getReadIdsStorageKey() {
          return state.archiveEnabled ? READ_IDS_KEY_ARCHIVE : READ_IDS_KEY_NON_ARCHIVE;
        }

        function byId(id) {
          return document.getElementById(id);
        }

        function htmlEscape(text) {
          return String(text ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        }

        function postToHost(type, payload) {
          try {
            const webview = window.chrome && window.chrome.webview;
            if (webview && typeof webview.postMessage === "function") {
              webview.postMessage({ type, payload: payload || {} });
            }
          } catch (_) {}
        }

        function formatDate(isoUtc) {
          try {
            if (!isoUtc) return "";
            const d = new Date(isoUtc);
            if (Number.isNaN(d.getTime())) return "";
            return d.toLocaleString();
          } catch (_) {
            return "";
          }
        }

        function loadReadPostIds() {
          try {
            readPostIds.clear();
            const raw = localStorage.getItem(getReadIdsStorageKey());
            if (!raw) return;
            const items = JSON.parse(raw);
            if (!Array.isArray(items)) return;
            for (const item of items) {
              const id = String(item || "").trim();
              if (id) readPostIds.add(id);
            }
          } catch (_) {}
        }

        function saveReadPostIds() {
          try {
            localStorage.setItem(getReadIdsStorageKey(), JSON.stringify(Array.from(readPostIds)));
          } catch (_) {}
        }

        function getVisiblePosts() {
          if (state.showArchived) {
            return Array.isArray(state.archivedMessages) ? state.archivedMessages : [];
          }

          const livePosts = Array.isArray(state.posts) ? state.posts : [];
          if (!state.archiveEnabled) {
            return livePosts;
          }

          const archivedKeys = new Set(
            (Array.isArray(state.archivedMessages) ? state.archivedMessages : [])
              .map((item) => String(item && item.sourcePostKey ? item.sourcePostKey : "").trim())
              .filter(Boolean)
          );

          return livePosts.filter((post) => {
            const postKey = getPostKey(post);
            return !readPostIds.has(postKey) && !archivedKeys.has(postKey);
          });
        }

        function getPostKey(post) {
          const id = String(post && post.id ? post.id : "").trim();
          if (id) return id;

          const title = String(post && post.title ? post.title : "").trim();
          const dateUtc = String(post && post.dateUtc ? post.dateUtc : "").trim();
          const postUrl = String(post && post.postUrl ? post.postUrl : "").trim();
          const linkUrl = String(post && post.linkUrl ? post.linkUrl : "").trim();
          const content = String(post && post.content ? post.content : "").trim();
          if (postUrl || linkUrl) {
            return `local:${title}|${dateUtc}|${postUrl}|${linkUrl}|${content}`;
          }
          return `local:${title}|${dateUtc}|${content}`;
        }

        function findPostByKey(postKey) {
          const key = String(postKey || "").trim();
          if (!key) return null;

          const posts = Array.isArray(state.posts) ? state.posts : [];
          for (const post of posts) {
            if (getPostKey(post) === key) return post;
          }

          return null;
        }

        function markPostRead(postKey) {
          const key = String(postKey || "").trim();
          if (!key) return;

          if (readPostIds.has(key)) return;

          readPostIds.add(key);
          saveReadPostIds();

          const post = findPostByKey(key);
          postToHost("mark_read", {
            id: String(post && post.id ? post.id : "").trim(),
            postKey: key,
            title: String(post && post.title ? post.title : "").trim(),
            content: String(post && post.content ? post.content : "").trim(),
            category: String(post && post.category ? post.category : "").trim(),
            dateUtc: String(post && post.dateUtc ? post.dateUtc : "").trim(),
            postUrl: String(post && post.postUrl ? post.postUrl : "").trim(),
            linkUrl: String(post && post.linkUrl ? post.linkUrl : "").trim(),
            linkText: String(post && post.linkText ? post.linkText : "").trim()
          });

          render();
        }

        function statusClass(status) {
          if (status === "ok") return "ok";
          if (status === "error" || status === "config_error") return "error";
          return "warn";
        }

        function renderStatus() {
          const statusEl = byId("status");
          const dotEl = byId("titleDot");

          const msg = state.message || "";
          const syncText = state.lastSyncUtc ? `Last sync: ${formatDate(state.lastSyncUtc)}` : "Last sync: --";
          const cfg = state.configPath ? `<div class=\"mono\">Config: ${htmlEscape(state.configPath)}</div>` : "";

          statusEl.className = `status ${statusClass(state.status)}`;
          if (state.status === "ok") {
            statusEl.innerHTML = `<div>${htmlEscape(syncText)}</div>`;
          } else {
            statusEl.innerHTML = `
              <div>${htmlEscape(msg)}</div>
              <div>${htmlEscape(syncText)}</div>
              ${cfg}
            `;
          }

          if (state.status === "ok") {
            dotEl.style.background = "var(--ok)";
            dotEl.style.boxShadow = "0 0 0 6px #39d98a22";
          } else if (state.status === "loading") {
            dotEl.style.background = "var(--accent-2)";
            dotEl.style.boxShadow = "0 0 0 6px #5be0ff22";
          } else {
            dotEl.style.background = "var(--danger)";
            dotEl.style.boxShadow = "0 0 0 6px #ff7a7a22";
          }
        }

        function renderFeed() {
          const feed = byId("feed");
          const posts = getVisiblePosts();

          if (state.showArchived) {
            if (posts.length === 0) {
              feed.innerHTML = `<div class=\"empty\">NO ARCHIVED MESSAGES</div>`;
              return;
            }

            const archiveHtml = posts.map((post) => {
              const title = htmlEscape(post.title || "Untitled post");
              const category = htmlEscape(post.category || "Update");
              const originalWhen = htmlEscape(formatDate(post.dateUtc) || "--");
              const ackWhen = htmlEscape(formatDate(post.ackUtc) || "--");
              const content = htmlEscape(post.content || "");

              return `
                <article class=\"card read\">
                  <div class=\"card-head\">
                    <h3 class=\"card-title\">${title}</h3>
                  </div>
                  <div class=\"card-meta\">
                    <span class=\"badge\">${category}</span>
                    <span class=\"time\">Posted: ${originalWhen}</span>
                    <span class=\"time\">Read: ${ackWhen}</span>
                  </div>
                  <p class=\"content\">${content}</p>
                </article>
              `;
            }).join("");

            feed.innerHTML = archiveHtml;
            return;
          }

          const newIds = new Set(Array.isArray(state.newPostIds) ? state.newPostIds.map(String) : []);

          if (posts.length === 0) {
            feed.innerHTML = `<div class=\"empty\">NO NEW POSTS</div>`;
            return;
          }

          const html = posts.map((post) => {
            const id = String(post.id ?? "");
            const postKey = getPostKey(post);
            const title = htmlEscape(post.title || "Untitled post");
            const category = htmlEscape(post.category || "Update");
            const when = htmlEscape(formatDate(post.dateUtc));
            const content = htmlEscape(post.content || "");
            const isRead = readPostIds.has(postKey);
            const newClass = !isRead && newIds.has(id) ? "new" : "";
            const readClass = isRead ? "read" : "";
            const markReadAction = isRead
              ? ""
              : `<div class=\"card-actions\"><button type=\"button\" class=\"link-btn mark-read-btn\" data-mark-read-key=\"${htmlEscape(postKey)}\">OK</button></div>`;

            return `
              <article class=\"card ${newClass} ${readClass}\" data-id=\"${htmlEscape(id)}\">
                <div class=\"card-head\">
                  <h3 class=\"card-title\">${title}</h3>
                </div>
                <div class=\"card-meta\">
                  <span class=\"badge\">${category}</span>
                  <span class=\"time\">${when}</span>
                </div>
                <p class=\"content\">${content}</p>
                ${markReadAction}
              </article>
            `;
          }).join("");

          feed.innerHTML = html;
        }

        function renderMeta() {
          const visibleCount = getVisiblePosts().length;
          byId("countPill").textContent = state.showArchived ? `Archived: ${visibleCount}` : `Posts: ${visibleCount}`;

          const archiveBtn = byId("archiveBtn");
          if (archiveBtn) {
            archiveBtn.hidden = !state.archiveEnabled;
            archiveBtn.classList.toggle("active", state.showArchived);
            archiveBtn.setAttribute("aria-pressed", state.showArchived ? "true" : "false");
          }
        }

        function render() {
          renderMeta();
          renderStatus();
          renderFeed();
        }

        function setState(next) {
          if (!next || typeof next !== "object") return;

          state.status = String(next.status || state.status || "loading");
          state.message = String(next.message || "");
          state.refreshMs = Number(next.refreshMs || state.refreshMs || 0);
          state.lastSyncUtc = next.lastSyncUtc || state.lastSyncUtc;
          state.configPath = String(next.configPath || state.configPath || "");
          state.posts = Array.isArray(next.posts) ? next.posts : state.posts;
          state.newPostIds = Array.isArray(next.newPostIds) ? next.newPostIds : [];

          render();
        }

        function setArchiveState(next) {
          if (!next || typeof next !== "object") return;

          const previousEnabled = state.archiveEnabled;
          state.archiveEnabled = Boolean(next.enabled);
          state.archivedMessages = Array.isArray(next.messages) ? next.messages : [];

          if (previousEnabled !== state.archiveEnabled) {
            loadReadPostIds();
          }

          if (!state.archiveEnabled) {
            state.showArchived = false;
            state.archivedMessages = [];
          }

          render();
        }

        function bindEvents() {
          document.addEventListener("click", (e) => {
            const target = e.target;
            if (!(target instanceof Element)) return;

            const markRead = target.closest("[data-mark-read-key]");
            if (markRead) {
              const key = markRead.getAttribute("data-mark-read-key") || "";
              if (key) markPostRead(key);
              return;
            }

            const archiveBtn = target.closest("#archiveBtn");
            if (archiveBtn) {
              if (!state.archiveEnabled) return;
              state.showArchived = !state.showArchived;
              render();
              return;
            }

            const btn = target.closest("[data-open-url]");
            if (!btn) return;

            const url = btn.getAttribute("data-open-url") || "";
            if (!url) return;

            postToHost("open_external", { url });
          });

          try {
            const webview = window.chrome && window.chrome.webview;
            if (webview && typeof webview.addEventListener === "function") {
              webview.addEventListener("message", (event) => {
                const msg = event && event.data ? event.data : null;
                if (!msg || typeof msg !== "object") return;
                if (msg.type === "state") {
                  setState(msg.payload || {});
                  return;
                }

                if (msg.type === "archive_state") {
                  setArchiveState(msg.payload || {});
                }
              });
            }
          } catch (_) {}
        }

        window.__BV_BOOT__ = function () {
          if (booted) return;
          booted = true;

          const cfg = window.__BV_CFG__ || {};
          state.refreshMs = Number(cfg.refresh_ms || 0);
          state.configPath = String(cfg.config_path || "");
          state.archiveEnabled = Boolean(cfg.archive_messages);
          loadReadPostIds();
          if (!state.archiveEnabled) {
            state.showArchived = false;
            state.archivedMessages = [];
          }
          state.status = "loading";
          state.message = "Connecting to Beamer API…";

          bindEvents();
          render();
          postToHost("ui_ready", {});
        };
      })();
    </script>
  </body>
</html>
