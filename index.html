<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Beamer_viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg-0: #071a2f;
        --bg-1: #0a2442;
        --panel: #102f53;
        --panel-muted: #143b66;
        --text-main: #e8f1ff;
        --text-muted: #9bb8dc;
        --accent: #2ed3a0;
        --accent-2: #5be0ff;
        --danger: #ff7a7a;
        --ok: #39d98a;
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        color: var(--text-main);
        background:
          radial-gradient(1200px 600px at -20% -10%, #1a4a7f55 0%, #00000000 60%),
          radial-gradient(900px 500px at 120% 110%, #1bbf9f2b 0%, #00000000 60%),
          linear-gradient(160deg, var(--bg-0), var(--bg-1));
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        overflow: hidden;
      }

      .app {
        height: 100%;
        display: grid;
        grid-template-rows: auto auto 1fr;
      }

      .top {
        padding: 16px 16px 10px;
        border-bottom: 1px solid #25517f66;
        background: linear-gradient(180deg, #0e2a4bcc 0%, #0e2a4b88 100%);
        backdrop-filter: blur(8px);
      }

      .top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .title-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--ok);
        box-shadow: 0 0 0 6px #39d98a22;
      }

      .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 12px;
      }

      .pill {
        border: 1px solid #2a5988;
        border-radius: 999px;
        padding: 4px 10px;
        background: #0f3157;
      }

      .status {
        margin: 12px 16px 0;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1.4;
        border: 1px solid #2a5e91;
        background: #11365e;
        color: var(--text-main);
      }

      .status.ok {
        border-color: #1f7f5f;
        background: #0e3a30;
      }

      .status.warn {
        border-color: #7d5d2f;
        background: #3f2e16;
      }

      .status.error {
        border-color: #7f3131;
        background: #3d1e1e;
      }

      .feed {
        min-height: 0;
        overflow: auto;
        padding: 14px 12px 16px;
        display: grid;
        grid-template-columns: 1fr;
        align-content: start;
        gap: 10px;
      }

      .empty {
        margin: 24px 6px 0;
        padding: 16px;
        border-radius: var(--radius);
        border: 1px dashed #2f669a;
        color: var(--text-muted);
        text-align: center;
        background: #0f31534d;
      }

      .card {
        border: 1px solid #4f95d3;
        border-radius: var(--radius);
        background: linear-gradient(180deg, #1a5b92 0%, #174a79 100%);
        padding: 12px;
        box-shadow: 0 8px 26px #051b3166, inset 0 1px 0 #9dd5ff33;
      }

      .card.new {
        border-color: #62cbff;
        box-shadow: 0 0 0 1px #62cbff66, 0 10px 32px #0e3c66a8;
      }

      .card-head {
        display: flex;
        align-items: start;
        justify-content: space-between;
        gap: 10px;
      }

      .card-title {
        margin: 0;
        font-size: 15px;
        line-height: 1.3;
      }

      .card-meta {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .badge {
        border: 1px solid #63afea;
        background: #1d5f97;
        color: #e8f4ff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
      }

      .time {
        color: var(--text-muted);
        font-size: 11px;
      }

      .content {
        margin: 10px 0 0;
        white-space: pre-wrap;
        font-size: 13px;
        line-height: 1.45;
        color: #dfecff;
      }

      .card-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
      }

      .link-btn {
        border: 1px solid #2d7cbb;
        background: linear-gradient(180deg, #1a5e95, #174f80);
        color: #ecf6ff;
        padding: 6px 10px;
        border-radius: 9px;
        font-size: 12px;
        cursor: pointer;
      }

      .link-btn:hover {
        filter: brightness(1.06);
      }

      .mark-read-btn {
        border-color: #69b9ec;
        background: linear-gradient(180deg, #2879b8, #1f6298);
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <div class="top-row">
          <div class="title">
            <span class="title-dot" id="titleDot"></span>
            <span>Beamer Viewer</span>
          </div>
          <div class="meta">
            <span class="pill" id="countPill">Posts: --</span>
          </div>
        </div>
      </div>

      <div id="status" class="status">Starting…</div>

      <main id="feed" class="feed" aria-live="polite"></main>
    </div>

    <script>
      (function () {
        let booted = false;
        const READ_IDS_KEY = "bv_read_post_ids_v1";

        const state = {
          status: "loading",
          message: "Starting…",
          refreshMs: 0,
          lastSyncUtc: null,
          configPath: "",
          posts: [],
          newPostIds: []
        };
        const readPostIds = new Set();

        function byId(id) {
          return document.getElementById(id);
        }

        function htmlEscape(text) {
          return String(text ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        }

        function postToHost(type, payload) {
          try {
            const webview = window.chrome && window.chrome.webview;
            if (webview && typeof webview.postMessage === "function") {
              webview.postMessage({ type, payload: payload || {} });
            }
          } catch (_) {}
        }

        function formatDate(isoUtc) {
          try {
            if (!isoUtc) return "";
            const d = new Date(isoUtc);
            if (Number.isNaN(d.getTime())) return "";
            return d.toLocaleString();
          } catch (_) {
            return "";
          }
        }

        function loadReadPostIds() {
          try {
            const raw = localStorage.getItem(READ_IDS_KEY);
            if (!raw) return;
            const items = JSON.parse(raw);
            if (!Array.isArray(items)) return;
            for (const item of items) {
              const id = String(item || "").trim();
              if (id) readPostIds.add(id);
            }
          } catch (_) {}
        }

        function saveReadPostIds() {
          try {
            localStorage.setItem(READ_IDS_KEY, JSON.stringify(Array.from(readPostIds)));
          } catch (_) {}
        }

        function getVisiblePosts() {
          const posts = Array.isArray(state.posts) ? state.posts : [];
          return posts.filter((post) => {
            const key = getPostKey(post);
            return !readPostIds.has(key);
          });
        }

        function getPostKey(post) {
          const id = String(post && post.id ? post.id : "").trim();
          if (id) return id;

          const title = String(post && post.title ? post.title : "").trim();
          const dateUtc = String(post && post.dateUtc ? post.dateUtc : "").trim();
          const content = String(post && post.content ? post.content : "").trim();
          return `local:${title}|${dateUtc}|${content}`;
        }

        function markPostRead(postKey, beamerPostId) {
          const key = String(postKey || "").trim();
          if (!key) return;

          if (!readPostIds.has(key)) {
            readPostIds.add(key);
            saveReadPostIds();
          }

          const id = String(beamerPostId || "").trim();
          if (id) {
            postToHost("mark_read", { id });
          }

          render();
        }

        function statusClass(status) {
          if (status === "ok") return "ok";
          if (status === "error" || status === "config_error") return "error";
          return "warn";
        }

        function renderStatus() {
          const statusEl = byId("status");
          const dotEl = byId("titleDot");

          const msg = state.message || "";
          const syncText = state.lastSyncUtc ? `Last sync: ${formatDate(state.lastSyncUtc)}` : "Last sync: --";
          const cfg = state.configPath ? `<div class=\"mono\">Config: ${htmlEscape(state.configPath)}</div>` : "";

          statusEl.className = `status ${statusClass(state.status)}`;
          if (state.status === "ok") {
            statusEl.innerHTML = `<div>${htmlEscape(syncText)}</div>`;
          } else {
            statusEl.innerHTML = `
              <div>${htmlEscape(msg)}</div>
              <div>${htmlEscape(syncText)}</div>
              ${cfg}
            `;
          }

          if (state.status === "ok") {
            dotEl.style.background = "var(--ok)";
            dotEl.style.boxShadow = "0 0 0 6px #39d98a22";
          } else if (state.status === "loading") {
            dotEl.style.background = "var(--accent-2)";
            dotEl.style.boxShadow = "0 0 0 6px #5be0ff22";
          } else {
            dotEl.style.background = "var(--danger)";
            dotEl.style.boxShadow = "0 0 0 6px #ff7a7a22";
          }
        }

        function renderFeed() {
          const feed = byId("feed");
          const posts = getVisiblePosts();
          const newIds = new Set(Array.isArray(state.newPostIds) ? state.newPostIds.map(String) : []);

          if (posts.length === 0) {
            feed.innerHTML = `<div class=\"empty\">NO NEW POSTS</div>`;
            return;
          }

          const html = posts.map((post) => {
            const id = String(post.id ?? "");
            const postKey = getPostKey(post);
            const title = htmlEscape(post.title || "Untitled post");
            const category = htmlEscape(post.category || "Update");
            const when = htmlEscape(formatDate(post.dateUtc));
            const content = htmlEscape(post.content || "");
            const newClass = newIds.has(id) ? "new" : "";
            const markReadAction = `<div class=\"card-actions\"><button type=\"button\" class=\"link-btn mark-read-btn\" data-mark-read-key=\"${htmlEscape(postKey)}\" data-mark-read-id=\"${htmlEscape(id)}\">Mark as read</button></div>`;

            return `
              <article class=\"card ${newClass}\" data-id=\"${htmlEscape(id)}\">
                <div class=\"card-head\">
                  <h3 class=\"card-title\">${title}</h3>
                </div>
                <div class=\"card-meta\">
                  <span class=\"badge\">${category}</span>
                  <span class=\"time\">${when}</span>
                </div>
                <p class=\"content\">${content}</p>
                ${markReadAction}
              </article>
            `;
          }).join("");

          feed.innerHTML = html;
        }

        function renderMeta() {
          byId("countPill").textContent = `Posts: ${getVisiblePosts().length}`;
        }

        function render() {
          renderMeta();
          renderStatus();
          renderFeed();
        }

        function setState(next) {
          if (!next || typeof next !== "object") return;

          state.status = String(next.status || state.status || "loading");
          state.message = String(next.message || "");
          state.refreshMs = Number(next.refreshMs || state.refreshMs || 0);
          state.lastSyncUtc = next.lastSyncUtc || state.lastSyncUtc;
          state.configPath = String(next.configPath || state.configPath || "");
          state.posts = Array.isArray(next.posts) ? next.posts : state.posts;
          state.newPostIds = Array.isArray(next.newPostIds) ? next.newPostIds : [];

          render();
        }

        function bindEvents() {
          document.addEventListener("click", (e) => {
            const target = e.target;
            if (!(target instanceof Element)) return;

            const markRead = target.closest("[data-mark-read-key]");
            if (markRead) {
              const key = markRead.getAttribute("data-mark-read-key") || "";
              const id = markRead.getAttribute("data-mark-read-id") || "";
              if (key) markPostRead(key, id);
              return;
            }

            const btn = target.closest("[data-open-url]");
            if (!btn) return;

            const url = btn.getAttribute("data-open-url") || "";
            if (!url) return;

            postToHost("open_external", { url });
          });

          try {
            const webview = window.chrome && window.chrome.webview;
            if (webview && typeof webview.addEventListener === "function") {
              webview.addEventListener("message", (event) => {
                const msg = event && event.data ? event.data : null;
                if (!msg || typeof msg !== "object") return;
                if (msg.type === "state") {
                  setState(msg.payload || {});
                }
              });
            }
          } catch (_) {}
        }

        window.__BV_BOOT__ = function () {
          if (booted) return;
          booted = true;
          loadReadPostIds();

          const cfg = window.__BV_CFG__ || {};
          state.refreshMs = Number(cfg.refresh_ms || 0);
          state.configPath = String(cfg.config_path || "");
          state.status = "loading";
          state.message = "Connecting to Beamer API…";

          bindEvents();
          render();
          postToHost("ui_ready", {});
        };
      })();
    </script>
  </body>
</html>
