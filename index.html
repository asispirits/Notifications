<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Notifications</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg-0: #ffffff;
        --bg-1: #ffffff;
        --panel: #ffffff;
        --panel-muted: #f4f9ff;
        --text-main: #1a4e86;
        --text-muted: #4b6f95;
        --accent: #0000ff;
        --accent-2: #80ffff;
        --danger: #d43d3d;
        --ok: #0000ff;
        --header-start: #ffffff;
        --header-end: #f5faff;
        --unread-start: #6bbbf6;
        --unread-end: #519fdd;
        --read-start: #758499;
        --read-end: #657486;
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
      }

      [hidden] {
        display: none !important;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        color: var(--text-main);
        background: var(--bg-0);
        font-family: "IBM Plex Sans", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        overflow: hidden;
      }

      .app {
        height: 100%;
        display: grid;
        grid-template-rows: auto auto 1fr;
      }

      .top {
        padding: 16px 16px 10px;
        border-bottom: 1px solid #c4d9ef;
        background: linear-gradient(180deg, var(--header-start) 0%, var(--header-end) 100%);
      }

      .top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }

      .title-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--ok);
        box-shadow: 0 0 0 6px #0000ff22;
      }

      .meta {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 12px;
      }

      .pill {
        border: 1px solid #b5cae2;
        border-radius: 999px;
        padding: 4px 10px;
        background: #ffffff;
      }

      .settings-btn {
        font-weight: 700;
        color: var(--text-main);
        cursor: pointer;
      }

      .status {
        margin: 12px 16px 0;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1.4;
        border: 1px solid #b7cee7;
        background: #f4f9ff;
        color: var(--text-main);
      }

      .status.ok {
        border-color: var(--accent-2);
        background: #eefeff;
      }

      .status.warn {
        border-color: #ffff80;
        background: #fffef0;
      }

      .status.error {
        border-color: #f0a8a8;
        background: #fff2f2;
      }

      .feed {
        min-height: 0;
        overflow: auto;
        padding: 14px 12px 16px;
        display: grid;
        grid-template-columns: 1fr;
        align-content: start;
        gap: 10px;
      }

      .empty {
        margin: 24px 6px 0;
        padding: 16px;
        border-radius: var(--radius);
        border: 1px dashed var(--accent-2);
        color: var(--text-muted);
        text-align: center;
        background: #f6ffff;
      }

      .card {
        border: 1px solid #3f88c7;
        border-radius: var(--radius);
        background: linear-gradient(180deg, var(--unread-start) 0%, var(--unread-end) 100%);
        padding: 12px;
        box-shadow: 0 8px 20px #2a618f47, inset 0 1px 0 #bfe0f861;
      }

      .card.new {
        border-color: #6dc3ff;
        background: linear-gradient(180deg, var(--unread-start) 0%, var(--unread-end) 100%);
        box-shadow: 0 0 0 1px #9be1ff72, 0 10px 24px #3177b954;
      }

      .card.read {
        border-color: #9ca9ba;
        background: linear-gradient(180deg, var(--read-start) 0%, var(--read-end) 100%);
        box-shadow: 0 6px 18px #4756673b, inset 0 1px 0 #d8e0e933;
      }

      .card.read .card-title,
      .card.read .content {
        color: #f2f7fc;
      }

      .card.read .time {
        color: #dbe4ee;
      }

      .card.read .badge {
        border-color: #c8d2de;
        background: #8b99ab;
        color: #f3f7fb;
      }

      .card-head {
        display: flex;
        align-items: start;
        justify-content: space-between;
        gap: 10px;
      }

      .card-title {
        margin: 0;
        font-size: 15px;
        line-height: 1.3;
      }

      .card:not(.read) .card-title,
      .card:not(.read) .content {
        color: #ffffff;
        text-shadow: 0 1px 1px #255c879c;
      }

      .card:not(.read) .time {
        color: #e8f5ff;
      }

      .card-meta {
        margin-top: 6px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .badge {
        border: 1px solid #6aa9db;
        background: #2d74b2;
        color: #f5fbff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
      }

      .time {
        color: #2a5f94;
        font-size: 11px;
      }

      .content {
        margin: 10px 0 0;
        white-space: pre-wrap;
        font-size: 13px;
        line-height: 1.45;
        color: #1d4f82;
      }

      .card-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
      }

      .link-btn {
        border: 1px solid #8eb7df;
        background: linear-gradient(180deg, #f7fbff, #ecf4ff);
        color: #1a4e86;
        padding: 6px 10px;
        border-radius: 9px;
        font-size: 12px;
        cursor: pointer;
      }

      .link-btn:hover {
        filter: brightness(1.06);
      }

      .link-btn:disabled {
        cursor: default;
        opacity: 0.72;
        filter: none;
      }

      .mark-read-btn {
        border-color: #7aa8d0;
        background: #f6fbff;
        color: #1a4e86;
        font-weight: 700;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: #00162d66;
        display: grid;
        place-items: center;
        z-index: 100;
      }

      .settings-modal {
        width: min(680px, calc(100% - 28px));
        max-height: calc(100% - 28px);
        overflow: auto;
        background: #ffffff;
        border: 1px solid #b7cee7;
        border-radius: 14px;
        box-shadow: 0 20px 40px #15345145;
        padding: 14px;
      }

      .settings-title {
        margin: 0 0 12px;
        font-size: 16px;
      }

      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .settings-field {
        display: grid;
        gap: 5px;
        font-size: 12px;
        color: var(--text-muted);
      }

      .settings-field input[type="text"] {
        width: 100%;
        border: 1px solid #b7cee7;
        border-radius: 8px;
        padding: 7px 8px;
        font: inherit;
        color: var(--text-main);
      }

      .settings-field input[type="color"] {
        width: 100%;
        height: 34px;
        border: 1px solid #b7cee7;
        border-radius: 8px;
        background: #fff;
        padding: 2px;
      }

      .settings-actions {
        margin-top: 12px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      .settings-message {
        margin-top: 8px;
        font-size: 12px;
        color: #1a4e86;
        min-height: 17px;
      }

      .settings-message.error {
        color: #b12c2c;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="top">
        <div class="top-row">
          <div class="title">
            <span class="title-dot" id="titleDot"></span>
            <span id="headerTitle">Notifications</span>
          </div>
          <div class="meta">
            <span class="pill" id="countPill">UNREAD POSTS: --</span>
            <button type="button" class="pill settings-btn" id="openSettingsBtn" hidden>SETTINGS</button>
          </div>
        </div>
      </div>

      <div id="status" class="status">Starting…</div>

      <main id="feed" class="feed" aria-live="polite"></main>
    </div>

    <div id="settingsOverlay" class="overlay" hidden>
      <section class="settings-modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <h2 class="settings-title" id="settingsTitle">UI Settings</h2>
        <div class="settings-grid">
          <label class="settings-field">
            App title
            <input id="cfgAppTitle" type="text" maxlength="80" />
          </label>
          <label class="settings-field">
            Header title
            <input id="cfgHeaderTitle" type="text" maxlength="80" />
          </label>
          <label class="settings-field">
            Page background
            <input id="cfgThemePageBackground" type="color" />
          </label>
          <label class="settings-field">
            Header start
            <input id="cfgThemeHeaderStart" type="color" />
          </label>
          <label class="settings-field">
            Header end
            <input id="cfgThemeHeaderEnd" type="color" />
          </label>
          <label class="settings-field">
            Main text
            <input id="cfgThemeTextMain" type="color" />
          </label>
          <label class="settings-field">
            Muted text
            <input id="cfgThemeTextMuted" type="color" />
          </label>
          <label class="settings-field">
            Accent
            <input id="cfgThemeAccent" type="color" />
          </label>
          <label class="settings-field">
            Accent soft
            <input id="cfgThemeAccentSoft" type="color" />
          </label>
          <label class="settings-field">
            Unread start
            <input id="cfgThemeUnreadStart" type="color" />
          </label>
          <label class="settings-field">
            Unread end
            <input id="cfgThemeUnreadEnd" type="color" />
          </label>
          <label class="settings-field">
            Read start
            <input id="cfgThemeReadStart" type="color" />
          </label>
          <label class="settings-field">
            Read end
            <input id="cfgThemeReadEnd" type="color" />
          </label>
        </div>

        <div class="settings-actions">
          <button type="button" class="link-btn" id="settingsCancelBtn">Cancel</button>
          <button type="button" class="link-btn mark-read-btn" id="settingsSaveBtn">Save & Close</button>
        </div>
        <div id="settingsMessage" class="settings-message"></div>
      </section>
    </div>

    <script>
      (function () {
        let booted = false;
        const READ_IDS_KEY = "bv_read_post_ids_v3";

        const state = {
          status: "loading",
          message: "Starting…",
          refreshMs: 0,
          lastSyncUtc: null,
          configPath: "",
          posts: [],
          newPostIds: [],
          archivedMessages: []
        };

        const uiCfg = {
          enableSecretMenu: false,
          appTitle: "Notifications",
          headerTitle: "Notifications",
          themePageBackground: "#ffffff",
          themeHeaderStart: "#ffffff",
          themeHeaderEnd: "#f5faff",
          themeTextMain: "#1a4e86",
          themeTextMuted: "#4b6f95",
          themeAccent: "#0000ff",
          themeAccentSoft: "#80ffff",
          themeUnreadStart: "#6bbbf6",
          themeUnreadEnd: "#519fdd",
          themeReadStart: "#758499",
          themeReadEnd: "#657486"
        };

        const readPostIds = new Set();
        const trackedBeaconIds = new Set();
        const trackingCfg = {
          productId: "",
          beamerUserId: "",
          customUserId: "",
          firstName: "",
          lastName: "",
          email: ""
        };

        function byId(id) {
          return document.getElementById(id);
        }

        function htmlEscape(text) {
          return String(text ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        }

        function postToHost(type, payload) {
          try {
            const webview = window.chrome && window.chrome.webview;
            if (webview && typeof webview.postMessage === "function") {
              webview.postMessage({ type, payload: payload || {} });
            }
          } catch (_) {}
        }

        function formatDate(isoUtc) {
          try {
            if (!isoUtc) return "";
            const d = new Date(isoUtc);
            if (Number.isNaN(d.getTime())) return "";
            return d.toLocaleString();
          } catch (_) {
            return "";
          }
        }

        function toEpoch(isoUtc) {
          try {
            if (!isoUtc) return 0;
            const d = new Date(isoUtc);
            if (Number.isNaN(d.getTime())) return 0;
            return d.getTime();
          } catch (_) {
            return 0;
          }
        }

        function loadReadPostIds() {
          try {
            readPostIds.clear();
            const raw = localStorage.getItem(READ_IDS_KEY);
            if (!raw) return;
            const items = JSON.parse(raw);
            if (!Array.isArray(items)) return;
            for (const item of items) {
              const id = String(item || "").trim();
              if (id) readPostIds.add(id);
            }
          } catch (_) {}
        }

        function saveReadPostIds() {
          try {
            localStorage.setItem(READ_IDS_KEY, JSON.stringify(Array.from(readPostIds)));
          } catch (_) {}
        }

        function appendTrackParam(parts, key, value) {
          const v = String(value || "").trim();
          if (!v) return;
          parts.push(`${encodeURIComponent(key)}=${encodeURIComponent(v)}`);
        }

        function getTrackIdCandidates(post) {
          const values = [];
          const seen = new Set();

          function push(value) {
            const v = String(value || "").trim();
            if (!v) return;
            if (seen.has(v)) return;
            seen.add(v);
            values.push(v);
          }

          if (post && Array.isArray(post.trackIdCandidates)) {
            for (const item of post.trackIdCandidates) {
              push(item);
            }
          }

          push(post && post.id ? post.id : "");
          push(post && post.postKey ? post.postKey : "");
          push(post && post.code ? post.code : "");

          return values;
        }

        function trackViewViaBeacon(post) {
          const id = getTrackIdCandidates(post).find((candidate) => !candidate.toLowerCase().startsWith("local:")) || "";
          if (!id) return false;
          if (trackedBeaconIds.has(id)) return true;

          const productId = String(trackingCfg.productId || "").trim();
          if (!productId) return false;

          const parts = [];
          appendTrackParam(parts, "product", productId);
          appendTrackParam(parts, "id", id);
          appendTrackParam(parts, "code", String(post && post.code ? post.code : "").trim());

          const language = String((navigator && navigator.language) ? navigator.language : "").trim().slice(0, 2).toUpperCase();
          appendTrackParam(parts, "language", language);

          appendTrackParam(parts, "user_id", trackingCfg.beamerUserId);
          appendTrackParam(parts, "custom_user_id", trackingCfg.customUserId);
          appendTrackParam(parts, "firstname", trackingCfg.firstName);
          appendTrackParam(parts, "lastname", trackingCfg.lastName);
          appendTrackParam(parts, "email", trackingCfg.email);

          const url = `https://backend.getbeamer.com/track?${parts.join("&")}`;
          let sent = false;

          try {
            if (navigator && typeof navigator.sendBeacon === "function") {
              sent = navigator.sendBeacon(url);
            }
          } catch (_) {}

          if (!sent) {
            try {
              fetch(url, { method: "POST", mode: "no-cors", keepalive: true }).catch(() => {});
              sent = true;
            } catch (_) {}
          }

          if (sent) {
            trackedBeaconIds.add(id);
            return true;
          }

          return false;
        }

        function getPostKey(post) {
          const explicitKey = String(post && (post.postKey || post.sourcePostKey) ? (post.postKey || post.sourcePostKey) : "").trim();
          if (explicitKey) return explicitKey;

          const id = String(post && post.id ? post.id : "").trim();
          if (id) return id;

          const title = String(post && post.title ? post.title : "").trim();
          const dateUtc = String(post && post.dateUtc ? post.dateUtc : "").trim();
          const postUrl = String(post && post.postUrl ? post.postUrl : "").trim();
          const linkUrl = String(post && post.linkUrl ? post.linkUrl : "").trim();
          const content = String(post && post.content ? post.content : "").trim();
          if (postUrl || linkUrl) {
            return `local:${title}|${dateUtc}|${postUrl}|${linkUrl}|${content}`;
          }
          return `local:${title}|${dateUtc}|${content}`;
        }

        function mapArchivedToPost(archivedItem) {
          const mapped = {
            id: String(archivedItem && archivedItem.sourcePostId ? archivedItem.sourcePostId : "").trim(),
            code: String(archivedItem && archivedItem.sourcePostCode ? archivedItem.sourcePostCode : "").trim(),
            postKey: String(archivedItem && archivedItem.sourcePostKey ? archivedItem.sourcePostKey : "").trim(),
            title: String(archivedItem && archivedItem.title ? archivedItem.title : "Untitled post").trim(),
            content: String(archivedItem && archivedItem.content ? archivedItem.content : "").trim(),
            category: String(archivedItem && archivedItem.category ? archivedItem.category : "Update").trim(),
            dateUtc: String(archivedItem && archivedItem.dateUtc ? archivedItem.dateUtc : "").trim(),
            postUrl: String(archivedItem && archivedItem.postUrl ? archivedItem.postUrl : "").trim(),
            linkUrl: String(archivedItem && archivedItem.linkUrl ? archivedItem.linkUrl : "").trim(),
            linkText: String(archivedItem && archivedItem.linkText ? archivedItem.linkText : "").trim(),
            ackUtc: String(archivedItem && archivedItem.ackUtc ? archivedItem.ackUtc : "").trim()
          };

          if (!mapped.dateUtc && mapped.ackUtc) {
            mapped.dateUtc = mapped.ackUtc;
          }

          return mapped;
        }

        function getVisiblePosts() {
          const livePosts = Array.isArray(state.posts) ? state.posts : [];
          const archived = Array.isArray(state.archivedMessages) ? state.archivedMessages : [];

          const merged = [];
          const seen = new Set();

          for (const post of livePosts) {
            const key = getPostKey(post);
            if (!key || seen.has(key)) continue;
            seen.add(key);
            merged.push({ ...post, postKey: key });
          }

          for (const archivedItem of archived) {
            const post = mapArchivedToPost(archivedItem);
            const key = getPostKey(post);
            if (!key || seen.has(key)) continue;
            seen.add(key);
            merged.push(post);
          }

          merged.sort((a, b) => {
            const bTime = toEpoch(b.dateUtc || b.ackUtc || "");
            const aTime = toEpoch(a.dateUtc || a.ackUtc || "");
            return bTime - aTime;
          });

          return merged;
        }

        function findPostByKey(postKey) {
          const key = String(postKey || "").trim();
          if (!key) return null;

          const posts = getVisiblePosts();
          for (const post of posts) {
            if (getPostKey(post) === key) return post;
          }

          return null;
        }

        function markPostRead(postKey) {
          const key = String(postKey || "").trim();
          if (!key) return;

          if (readPostIds.has(key)) return;

          readPostIds.add(key);
          saveReadPostIds();

          const post = findPostByKey(key);
          const beaconTracked = false;
          postToHost("mark_read", {
            id: String(post && post.id ? post.id : "").trim(),
            code: String(post && post.code ? post.code : "").trim(),
            beaconTracked,
            trackIds: getTrackIdCandidates(post),
            postKey: key,
            title: String(post && post.title ? post.title : "").trim(),
            content: String(post && post.content ? post.content : "").trim(),
            category: String(post && post.category ? post.category : "").trim(),
            dateUtc: String(post && post.dateUtc ? post.dateUtc : "").trim(),
            postUrl: String(post && post.postUrl ? post.postUrl : "").trim(),
            linkUrl: String(post && post.linkUrl ? post.linkUrl : "").trim(),
            linkText: String(post && post.linkText ? post.linkText : "").trim()
          });

          render();
        }

        function statusClass(status) {
          if (status === "ok") return "ok";
          if (status === "error" || status === "config_error") return "error";
          return "warn";
        }

        function renderStatus() {
          const statusEl = byId("status");
          const dotEl = byId("titleDot");

          const msg = state.message || "";
          const syncText = state.lastSyncUtc ? `Last sync: ${formatDate(state.lastSyncUtc)}` : "Last sync: --";
          const cfg = state.configPath ? `<div class=\"mono\">Config: ${htmlEscape(state.configPath)}</div>` : "";

          statusEl.className = `status ${statusClass(state.status)}`;
          if (state.status === "ok") {
            statusEl.innerHTML = `<div>${htmlEscape(syncText)}</div>`;
          } else {
            statusEl.innerHTML = `
              <div>${htmlEscape(msg)}</div>
              <div>${htmlEscape(syncText)}</div>
              ${cfg}
            `;
          }

          if (state.status === "ok") {
            dotEl.style.background = "var(--ok)";
            dotEl.style.boxShadow = "0 0 0 6px #39d98a22";
          } else if (state.status === "loading") {
            dotEl.style.background = "var(--accent-2)";
            dotEl.style.boxShadow = "0 0 0 6px #5be0ff22";
          } else {
            dotEl.style.background = "var(--danger)";
            dotEl.style.boxShadow = "0 0 0 6px #ff7a7a22";
          }
        }

        function renderFeed() {
          const feed = byId("feed");
          const posts = getVisiblePosts();
          const newIds = new Set(Array.isArray(state.newPostIds) ? state.newPostIds.map(String) : []);

          if (posts.length === 0) {
            feed.innerHTML = `<div class=\"empty\">NO NEW POSTS</div>`;
            return;
          }

          const html = posts.map((post) => {
            const id = String(post.id ?? "");
            const postKey = getPostKey(post);
            const title = htmlEscape(post.title || "Untitled post");
            const category = htmlEscape(post.category || "Update");
            const when = htmlEscape(formatDate(post.dateUtc || post.ackUtc || ""));
            const content = htmlEscape(post.content || "");
            const isRead = readPostIds.has(postKey);
            const newClass = !isRead && id && newIds.has(id) ? "new" : "";
            const readClass = isRead ? "read" : "";
            const markReadAction = isRead
              ? ""
              : `<div class=\"card-actions\"><button type=\"button\" class=\"link-btn mark-read-btn\" data-mark-read-key=\"${htmlEscape(postKey)}\">OK</button></div>`;

            return `
              <article class=\"card ${newClass} ${readClass}\" data-id=\"${htmlEscape(id)}\">
                <div class=\"card-head\">
                  <h3 class=\"card-title\">${title}</h3>
                </div>
                <div class=\"card-meta\">
                  <span class=\"badge\">${category}</span>
                  <span class=\"time\">${when}</span>
                </div>
                <p class=\"content\">${content}</p>
                ${markReadAction}
              </article>
            `;
          }).join("");

          feed.innerHTML = html;
        }

        function renderMeta() {
          const unreadCount = getVisiblePosts().filter((post) => !readPostIds.has(getPostKey(post))).length;
          byId("countPill").textContent = `UNREAD POSTS: ${unreadCount}`;
        }

        function render() {
          renderMeta();
          renderStatus();
          renderFeed();
        }

        function setState(next) {
          if (!next || typeof next !== "object") return;

          state.status = String(next.status || state.status || "loading");
          state.message = String(next.message || "");
          state.refreshMs = Number(next.refreshMs || state.refreshMs || 0);
          state.lastSyncUtc = next.lastSyncUtc || state.lastSyncUtc;
          state.configPath = String(next.configPath || state.configPath || "");
          state.posts = Array.isArray(next.posts) ? next.posts : state.posts;
          state.newPostIds = Array.isArray(next.newPostIds) ? next.newPostIds : [];

          render();
        }

        function setArchiveState(next) {
          if (!next || typeof next !== "object") return;

          state.archivedMessages = Array.isArray(next.messages) ? next.messages : [];
          render();
        }

        function normalizeHexColor(value, fallback) {
          const raw = String(value || "").trim();
          if (!/^#[0-9a-fA-F]{6}$/.test(raw)) return fallback;
          return raw.toLowerCase();
        }

        function normalizeTitle(value, fallback) {
          const title = String(value || "").trim();
          if (!title) return fallback;
          return title.slice(0, 80);
        }

        function normalizeBool(value, fallback) {
          if (typeof value === "boolean") return value;
          if (typeof value === "number") return value !== 0;
          if (typeof value === "string") {
            const raw = value.trim().toLowerCase();
            if (raw === "true" || raw === "1") return true;
            if (raw === "false" || raw === "0" || raw === "") return false;
          }
          return fallback;
        }

        function applyUiConfig(next) {
          if (!next || typeof next !== "object") return;

          const prevAppTitle = uiCfg.appTitle;

          if (Object.prototype.hasOwnProperty.call(next, "enable_secret_menu") || Object.prototype.hasOwnProperty.call(next, "enableSecretMenu")) {
            uiCfg.enableSecretMenu = normalizeBool(
              Object.prototype.hasOwnProperty.call(next, "enable_secret_menu") ? next.enable_secret_menu : next.enableSecretMenu,
              uiCfg.enableSecretMenu
            );
          }

          uiCfg.appTitle = normalizeTitle(next.ui_app_title ?? next.appTitle ?? uiCfg.appTitle, "Notifications");
          uiCfg.headerTitle = normalizeTitle(next.ui_header_title ?? next.headerTitle ?? uiCfg.headerTitle, uiCfg.appTitle);
          uiCfg.themePageBackground = normalizeHexColor(next.theme_page_background ?? next.themePageBackground ?? uiCfg.themePageBackground, "#ffffff");
          uiCfg.themeHeaderStart = normalizeHexColor(next.theme_header_start ?? next.themeHeaderStart ?? uiCfg.themeHeaderStart, "#ffffff");
          uiCfg.themeHeaderEnd = normalizeHexColor(next.theme_header_end ?? next.themeHeaderEnd ?? uiCfg.themeHeaderEnd, "#f5faff");
          uiCfg.themeTextMain = normalizeHexColor(next.theme_text_main ?? next.themeTextMain ?? uiCfg.themeTextMain, "#1a4e86");
          uiCfg.themeTextMuted = normalizeHexColor(next.theme_text_muted ?? next.themeTextMuted ?? uiCfg.themeTextMuted, "#4b6f95");
          uiCfg.themeAccent = normalizeHexColor(next.theme_accent ?? next.themeAccent ?? uiCfg.themeAccent, "#0000ff");
          uiCfg.themeAccentSoft = normalizeHexColor(next.theme_accent_soft ?? next.themeAccentSoft ?? uiCfg.themeAccentSoft, "#80ffff");
          uiCfg.themeUnreadStart = normalizeHexColor(next.theme_unread_start ?? next.themeUnreadStart ?? uiCfg.themeUnreadStart, "#6bbbf6");
          uiCfg.themeUnreadEnd = normalizeHexColor(next.theme_unread_end ?? next.themeUnreadEnd ?? uiCfg.themeUnreadEnd, "#519fdd");
          uiCfg.themeReadStart = normalizeHexColor(next.theme_read_start ?? next.themeReadStart ?? uiCfg.themeReadStart, "#758499");
          uiCfg.themeReadEnd = normalizeHexColor(next.theme_read_end ?? next.themeReadEnd ?? uiCfg.themeReadEnd, "#657486");

          const root = document.documentElement;
          root.style.setProperty("--bg-0", uiCfg.themePageBackground);
          root.style.setProperty("--bg-1", uiCfg.themePageBackground);
          root.style.setProperty("--text-main", uiCfg.themeTextMain);
          root.style.setProperty("--text-muted", uiCfg.themeTextMuted);
          root.style.setProperty("--accent", uiCfg.themeAccent);
          root.style.setProperty("--accent-2", uiCfg.themeAccentSoft);
          root.style.setProperty("--ok", uiCfg.themeAccent);
          root.style.setProperty("--header-start", uiCfg.themeHeaderStart);
          root.style.setProperty("--header-end", uiCfg.themeHeaderEnd);
          root.style.setProperty("--unread-start", uiCfg.themeUnreadStart);
          root.style.setProperty("--unread-end", uiCfg.themeUnreadEnd);
          root.style.setProperty("--read-start", uiCfg.themeReadStart);
          root.style.setProperty("--read-end", uiCfg.themeReadEnd);

          const headerTitle = byId("headerTitle");
          if (headerTitle) {
            headerTitle.textContent = uiCfg.headerTitle;
          }
          document.title = uiCfg.appTitle;

          const settingsBtn = byId("openSettingsBtn");
          if (settingsBtn) {
            settingsBtn.hidden = !uiCfg.enableSecretMenu;
          }

          if (!uiCfg.enableSecretMenu) {
            closeSettingsModal();
          }

          if (uiCfg.appTitle !== prevAppTitle) {
            renderStatus();
          }
        }

        function setSettingsMessage(message, isError) {
          const el = byId("settingsMessage");
          if (!el) return;
          el.textContent = String(message || "").trim();
          el.className = isError ? "settings-message error" : "settings-message";
        }

        function fillSettingsForm() {
          byId("cfgAppTitle").value = uiCfg.appTitle;
          byId("cfgHeaderTitle").value = uiCfg.headerTitle;
          byId("cfgThemePageBackground").value = uiCfg.themePageBackground;
          byId("cfgThemeHeaderStart").value = uiCfg.themeHeaderStart;
          byId("cfgThemeHeaderEnd").value = uiCfg.themeHeaderEnd;
          byId("cfgThemeTextMain").value = uiCfg.themeTextMain;
          byId("cfgThemeTextMuted").value = uiCfg.themeTextMuted;
          byId("cfgThemeAccent").value = uiCfg.themeAccent;
          byId("cfgThemeAccentSoft").value = uiCfg.themeAccentSoft;
          byId("cfgThemeUnreadStart").value = uiCfg.themeUnreadStart;
          byId("cfgThemeUnreadEnd").value = uiCfg.themeUnreadEnd;
          byId("cfgThemeReadStart").value = uiCfg.themeReadStart;
          byId("cfgThemeReadEnd").value = uiCfg.themeReadEnd;
          setSettingsMessage("", false);
        }

        function openSettingsModal() {
          if (!uiCfg.enableSecretMenu) return;
          fillSettingsForm();
          const overlay = byId("settingsOverlay");
          overlay.hidden = false;
        }

        function closeSettingsModal() {
          const overlay = byId("settingsOverlay");
          overlay.hidden = true;
        }

        function saveUiSettings() {
          const payload = {
            appTitle: byId("cfgAppTitle").value,
            headerTitle: byId("cfgHeaderTitle").value,
            themePageBackground: byId("cfgThemePageBackground").value,
            themeHeaderStart: byId("cfgThemeHeaderStart").value,
            themeHeaderEnd: byId("cfgThemeHeaderEnd").value,
            themeTextMain: byId("cfgThemeTextMain").value,
            themeTextMuted: byId("cfgThemeTextMuted").value,
            themeAccent: byId("cfgThemeAccent").value,
            themeAccentSoft: byId("cfgThemeAccentSoft").value,
            themeUnreadStart: byId("cfgThemeUnreadStart").value,
            themeUnreadEnd: byId("cfgThemeUnreadEnd").value,
            themeReadStart: byId("cfgThemeReadStart").value,
            themeReadEnd: byId("cfgThemeReadEnd").value,
            disableSecretMenuAfterSave: true
          };
          setSettingsMessage("Saving...", false);
          postToHost("save_ui_settings", payload);
        }

        function bindEvents() {
          document.addEventListener("click", (e) => {
            const target = e.target;
            if (!(target instanceof Element)) return;

            const markRead = target.closest("[data-mark-read-key]");
            if (markRead) {
              const key = markRead.getAttribute("data-mark-read-key") || "";
              if (key) markPostRead(key);
              return;
            }

            const btn = target.closest("[data-open-url]");
            if (!btn) return;

            const url = btn.getAttribute("data-open-url") || "";
            if (!url) return;

            postToHost("open_external", { url });
          });

          const openSettingsBtn = byId("openSettingsBtn");
          const settingsCancelBtn = byId("settingsCancelBtn");
          const settingsSaveBtn = byId("settingsSaveBtn");
          const settingsOverlay = byId("settingsOverlay");

          if (openSettingsBtn) {
            openSettingsBtn.addEventListener("click", openSettingsModal);
          }

          if (settingsCancelBtn) {
            settingsCancelBtn.addEventListener("click", closeSettingsModal);
          }

          if (settingsSaveBtn) {
            settingsSaveBtn.addEventListener("click", saveUiSettings);
          }

          if (settingsOverlay) {
            settingsOverlay.addEventListener("click", (event) => {
              if (event.target === settingsOverlay) {
                closeSettingsModal();
              }
            });
          }

          document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
              closeSettingsModal();
            }
          });

          try {
            const webview = window.chrome && window.chrome.webview;
            if (webview && typeof webview.addEventListener === "function") {
              webview.addEventListener("message", (event) => {
                const msg = event && event.data ? event.data : null;
                if (!msg || typeof msg !== "object") return;

                if (msg.type === "state") {
                  setState(msg.payload || {});
                  return;
                }

                if (msg.type === "archive_state") {
                  setArchiveState(msg.payload || {});
                  return;
                }

                if (msg.type === "ui_config") {
                  applyUiConfig(msg.payload || {});
                  render();
                  return;
                }

                if (msg.type === "ui_settings_saved") {
                  const success = !!(msg.payload && msg.payload.success);
                  const message = String(msg.payload && msg.payload.message ? msg.payload.message : "").trim();
                  setSettingsMessage(message || (success ? "UI settings saved." : "Unable to save UI settings."), !success);

                  if (success) {
                    closeSettingsModal();
                  }
                }
              });
            }
          } catch (_) {}
        }

        window.__BV_BOOT__ = function () {
          if (booted) return;
          booted = true;

          const cfg = window.__BV_CFG__ || {};
          state.refreshMs = Number(cfg.refresh_ms || 0);
          state.configPath = String(cfg.config_path || "");
          trackingCfg.beamerUserId = String(cfg.beamer_user_id || "").trim();
          trackingCfg.customUserId = String(cfg.custom_user_id || cfg.viewer_user_id || "").trim();
          trackingCfg.productId = String(cfg.product_id || "").trim();
          trackingCfg.firstName = String(cfg.viewer_first_name || "").trim();
          trackingCfg.lastName = String(cfg.viewer_last_name || "").trim();
          trackingCfg.email = String(cfg.viewer_email || "").trim();

          applyUiConfig(cfg);
          loadReadPostIds();
          state.status = "loading";
          state.message = "Connecting to Beamer API…";

          bindEvents();
          render();
          postToHost("ui_ready", {});
        };
      })();
    </script>
  </body>
</html>
